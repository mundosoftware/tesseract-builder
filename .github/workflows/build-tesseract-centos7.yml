# .github/workflows/build-tesseract-el7.yml
name: Build Tesseract for CentOS 7 (EL7) x86_64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build in CentOS 7 container and package artifacts
        run: |
          set -euo pipefail

          cat > Dockerfile <<'DOCKERFILE'
          FROM centos:7

          # CentOS 7 is EOL; switch repos to vault
          RUN sed -i 's/mirrorlist=/#mirrorlist=/g' /etc/yum.repos.d/CentOS-Base.repo && \
              sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-Base.repo

          # Use bash for RUN so we can source/enable toolsets cleanly
          SHELL ["/bin/bash", "-c"]

          # Base deps
          RUN yum -y install epel-release && \
              yum -y install \
                curl ca-certificates which tar gzip xz bash \
                git make autoconf automake libtool pkgconfig \
                leptonica leptonica-devel \
                libjpeg-turbo-devel libpng-devel libtiff-devel zlib-devel \
              && yum clean all

          # Install modern CMake (Tesseract requires >= 3.18)
          ARG CMAKE_VER=3.27.9
          RUN mkdir -p /opt/cmake && \
              curl -fsSL -o /tmp/cmake.sh \
                https://github.com/Kitware/CMake/releases/download/v${CMAKE_VER}/cmake-${CMAKE_VER}-linux-x86_64.sh && \
              chmod +x /tmp/cmake.sh && \
              bash /tmp/cmake.sh --skip-license --prefix=/opt/cmake && \
              ln -sf /opt/cmake/bin/cmake /usr/local/bin/cmake && \
              ln -sf /opt/cmake/bin/ctest /usr/local/bin/ctest && \
              ln -sf /opt/cmake/bin/cpack /usr/local/bin/cpack && \
              cmake --version

          WORKDIR /src

          # Pin versions for reproducibility (adjust if you want)
          ARG TESS_TAG=5.3.4

          RUN git clone --depth 1 --branch ${TESS_TAG} https://github.com/tesseract-ocr/tesseract.git

          WORKDIR /src/tesseract

          # Install Developer Toolset 10 for GCC 10 on CentOS 7
          RUN yum install -y centos-release-scl && \
              yum install -y devtoolset-10 && \
              source /opt/rh/devtoolset-10/enable

          # Build tesseract (with GCC10), training tools OFF, curl/archive OFF (smaller)
          # We intentionally target generic x86-64 (no AVX requirement).
          RUN source /opt/rh/devtoolset-10/enable && \
              set -euo pipefail && \
              gcc --version && g++ --version && \
              mkdir -p build && cd build && \
              cmake .. \
                -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_TRAINING_TOOLS=OFF \
                -DDISABLE_CURL=ON \
                -DDISABLE_ARCHIVE=ON \
                -DCMAKE_C_FLAGS="-O2 -pipe -march=x86-64 -mtune=generic" \
                -DCMAKE_CXX_FLAGS="-O2 -pipe -march=x86-64 -mtune=generic" && \
              make -j2 && \
              make install

          # Package into /out
          RUN mkdir -p /out/bin /out/bin/tessdata && \
              # Installed binary should be in /usr/local/bin/tesseract
              cp -f /usr/local/bin/tesseract /out/bin/tesseract && \
              chmod 0755 /out/bin/tesseract && \
              # Simple wrapper to ensure TESSDATA_PREFIX points to bundled tessdata
              cat > /out/bin/run_tesseract.sh <<'SH' && \
              chmod 0755 /out/bin/run_tesseract.sh && \
              # Download tessdata (eng + por)
              curl -fsSL -o /out/bin/tessdata/eng.traineddata \
                https://github.com/tesseract-ocr/tessdata_best/raw/main/eng.traineddata && \
              curl -fsSL -o /out/bin/tessdata/por.traineddata \
                https://github.com/tesseract-ocr/tessdata_best/raw/main/por.traineddata && \
              # Smoke test inside container (should print version)
              /out/bin/tesseract --version >/out/tesseract_version.txt || true && \
              bash /out/bin/run_tesseract.sh --version >/out/tesseract_wrapper_version.txt || true && \
              # Create tar.gz
              tar -C /out -czf /out/tesseract-el7-x86_64.tar.gz bin tesseract_version.txt tesseract_wrapper_version.txt

          SH
          #!/usr/bin/env bash
          set -euo pipefail

          # If called with --version (no input), forward directly
          if [[ "${1-}" == "--version" ]]; then
            export TESSDATA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/tessdata"
            exec "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/tesseract" --version
          fi

          # Normal mode:
          # run_tesseract.sh <image_path> <output_base> [tesseract args...]
          if [[ $# -lt 2 ]]; then
            echo "Usage: $0 <image_path> <output_base> [tesseract args...]" >&2
            exit 2
          fi

          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export TESSDATA_PREFIX="$SCRIPT_DIR/tessdata"

          IMG="$1"
          OUTBASE="$2"
          shift 2

          exec "$SCRIPT_DIR/tesseract" "$IMG" "$OUTBASE" "$@"
          SH
          DOCKERFILE

          docker build -t tesseract-el7-build .

          # Extract tarball from container
          CID=$(docker create tesseract-el7-build)
          docker cp "$CID:/out/tesseract-el7-x86_64.tar.gz" ./tesseract-el7-x86_64.tar.gz
          docker rm -f "$CID" >/dev/null

          echo "Built: ./tesseract-el7-x86_64.tar.gz"
          ls -lh ./tesseract-el7-x86_64.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-el7-x86_64
          path: tesseract-el7-x86_64.tar.gz
