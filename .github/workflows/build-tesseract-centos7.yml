name: Build Tesseract for EL7 (vault + SCL)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Build inside CentOS 7 (vault + devtoolset)
        shell: bash
        run: |
          set -euo pipefail

          cat > Dockerfile <<'EOF'
          FROM centos:7

          # --- CentOS 7 is EOL: point base repos to vault ---
          RUN set -euxo pipefail \
              && sed -i 's/^mirrorlist=/#mirrorlist=/g' /etc/yum.repos.d/CentOS-Base.repo \
              && sed -i 's|^#baseurl=http://mirror.centos.org/centos|baseurl=http://vault.centos.org/centos|g' /etc/yum.repos.d/CentOS-Base.repo \
              && yum -y install yum-utils ca-certificates curl \
              && yum clean all

          # --- Core build deps (EL7) ---
          RUN set -euxo pipefail \
              && yum -y install epel-release \
              && yum -y install \
                  gcc gcc-c++ make git \
                  autoconf automake libtool pkgconfig \
                  leptonica leptonica-devel \
                  libjpeg-turbo-devel libpng-devel libtiff-devel zlib-devel \
                  which tar gzip xz bash \
              && yum clean all

          # --- Install modern CMake (build tool only) ---
          ARG CMAKE_VER=3.27.9
          RUN set -euxo pipefail \
              && mkdir -p /opt/cmake \
              && curl -fsSL -o /tmp/cmake.sh \
                  "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VER}/cmake-${CMAKE_VER}-linux-x86_64.sh" \
              && chmod +x /tmp/cmake.sh \
              && bash /tmp/cmake.sh --skip-license --prefix=/opt/cmake \
              && ln -sf /opt/cmake/bin/cmake /usr/local/bin/cmake \
              && ln -sf /opt/cmake/bin/ctest /usr/local/bin/ctest \
              && ln -sf /opt/cmake/bin/cpack /usr/local/bin/cpack \
              && cmake --version

          # --- Fix (recommended): write proper SCLo repo files to vault.centos.org ---
          # Common gotcha: devtoolset packages live in SCLo repos; EOL mirrorlists break.
          RUN set -euxo pipefail \
              && yum -y install centos-release-scl centos-release-scl-rh scl-utils \
              && rm -f /etc/yum.repos.d/CentOS-SCLo-scl.repo /etc/yum.repos.d/CentOS-SCLo-rh.repo || true

          RUN set -euxo pipefail \
              && cat > /etc/yum.repos.d/CentOS-SCLo-scl.repo <<'REPO'
          [centos-sclo-sclo]
          name=CentOS-7 - SCLo sclo
          baseurl=http://vault.centos.org/centos/7.9.2009/sclo/x86_64/sclo/
          enabled=1
          gpgcheck=1
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
          skip_if_unavailable=1
          metadata_expire=6h
          REPO

          RUN set -euxo pipefail \
              && cat > /etc/yum.repos.d/CentOS-SCLo-rh.repo <<'REPO'
          [centos-sclo-rh]
          name=CentOS-7 - SCLo rh
          baseurl=http://vault.centos.org/centos/7.9.2009/sclo/x86_64/rh/
          enabled=1
          gpgcheck=1
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
          skip_if_unavailable=1
          metadata_expire=6h
          REPO

          # Optional sanity checks (so logs are obvious)
          RUN set -euxo pipefail \
              && yum -y clean all \
              && yum -y makecache fast \
              && yum repolist \
              && curl -fsSI http://vault.centos.org/centos/7.9.2009/sclo/x86_64/sclo/ >/dev/null \
              && curl -fsSI http://vault.centos.org/centos/7.9.2009/sclo/x86_64/rh/ >/dev/null

          # --- Install GCC10 via devtoolset-10 ---
          RUN set -euxo pipefail \
              && yum -y install devtoolset-10-gcc devtoolset-10-gcc-c++ \
              && yum clean all

          WORKDIR /src

          ARG TESS_TAG=5.3.3
          RUN set -euxo pipefail \
              && git clone --depth 1 --branch "${TESS_TAG}" https://github.com/tesseract-ocr/tesseract.git

          WORKDIR /src/tesseract

          RUN scl enable devtoolset-10 -- bash -lc '\
              set -euo pipefail; \
              echo "GCC:"; which gcc; gcc --version; \
              echo "G++:"; which g++; g++ --version; \
              mkdir -p build && cd build; \
              cmake .. \
                -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_TRAINING_TOOLS=OFF \
                -DDISABLE_CURL=ON \
                -DDISABLE_ARCHIVE=ON \
                -DCMAKE_C_FLAGS="-O2 -pipe -march=x86-64 -mtune=generic" \
                -DCMAKE_CXX_FLAGS="-O2 -pipe -march=x86-64 -mtune=generic"; \
              make -j2 \
          '

          # Stage output files
          RUN set -euxo pipefail \
              && mkdir -p /out/bin/tessdata \
              && cp -v /src/tesseract/build/bin/tesseract /out/bin/tesseract

          # Wrapper script (sets TESSDATA_PREFIX)
          RUN set -euxo pipefail \
              && cat > /out/bin/run_tesseract.sh <<'SH'
          #!/usr/bin/env bash
          set -euo pipefail
          HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export TESSDATA_PREFIX="${HERE}"
          exec "${HERE}/tesseract" "$@"
          SH
          RUN chmod +x /out/bin/run_tesseract.sh

          # Download tessdata (eng + por)
          RUN set -euxo pipefail \
              && curl -fsSL -o /out/bin/tessdata/eng.traineddata \
                  https://github.com/tesseract-ocr/tessdata_best/raw/main/eng.traineddata \
              && curl -fsSL -o /out/bin/tessdata/por.traineddata \
                  https://github.com/tesseract-ocr/tessdata_best/raw/main/por.traineddata

          WORKDIR /out
          RUN tar -czf /out/tesseract-el7.tar.gz bin
          EOF

          docker build --pull=false -t tesseract-el7 .
          docker create --name tesseract-el7-container tesseract-el7
          docker cp tesseract-el7-container:/out/tesseract-el7.tar.gz ./tesseract-el7.tar.gz
          docker rm -f tesseract-el7-container

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-el7
          path: tesseract-el7.tar.gz
