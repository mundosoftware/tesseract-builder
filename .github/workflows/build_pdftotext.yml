name: Build pdftotext bundle for EL7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Build inside CentOS 7 container (use vault repos)
        run: |
          docker run --rm -v "$PWD:/work" -w /work centos:7 bash -lc '
            set -euo pipefail

            # CentOS 7 is EOL; mirrorlist often fails.
            # Switch repos to vault.centos.org (static archive).
            sed -i "s|mirrorlist=|#mirrorlist=|g" /etc/yum.repos.d/CentOS-Base.repo
            sed -i "s|#baseurl=http://mirror.centos.org/centos|baseurl=http://vault.centos.org|g" /etc/yum.repos.d/CentOS-Base.repo

            # Optional: make yum more tolerant
            yum -y install yum-utils || true

            yum clean all
            yum makecache fast

            yum -y install poppler-utils

            mkdir -p out/bin out/lib

            cp -v /usr/bin/pdftotext out/bin/

            # Copy shared libs required by pdftotext
            ldd /usr/bin/pdftotext | awk "/=>/ {print \$3}" | while read -r lib; do
              if [ -f "$lib" ]; then
                cp -v "$lib" out/lib/
              fi
            done

            # Copy runtime loader (sometimes helps)
            if [ -f /lib64/ld-linux-x86-64.so.2 ]; then
              cp -v /lib64/ld-linux-x86-64.so.2 out/lib/
            fi

            cat > out/pdftotext.sh << "EOF"
            #!/bin/sh
            DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"
            export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"
            exec "$DIR/bin/pdftotext" "$@"
            EOF
            chmod +x out/pdftotext.sh

            tar -czf pdftotext-el7-bundle.tar.gz -C out .
          '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdftotext-el7-bundle
          path: pdftotext-el7-bundle.tar.gz
