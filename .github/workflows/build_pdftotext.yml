name: Build pdftotext bundle for EL7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Build inside CentOS 7 container
        run: |
          docker run --rm -v "$PWD:/work" -w /work centos:7 bash -lc '
            set -euo pipefail

            yum -y install yum-utils epel-release
            yum -y install poppler-utils

            # Collect binary + dependencies
            mkdir -p out/bin out/lib

            # pdftotext location on EL7
            cp -v /usr/bin/pdftotext out/bin/

            # Copy all shared libs required by pdftotext
            ldd /usr/bin/pdftotext | awk "/=>/ {print \$3}" | while read -r lib; do
              if [ -f "$lib" ]; then
                cp -v "$lib" out/lib/
              fi
            done

            # Also copy the runtime loader (sometimes needed in weird environments)
            if [ -f /lib64/ld-linux-x86-64.so.2 ]; then
              cp -v /lib64/ld-linux-x86-64.so.2 out/lib/
            fi

            # Wrapper that forces our bundled libs
            cat > out/pdftotext.sh << "EOF"
            #!/bin/sh
            DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"
            export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"
            exec "$DIR/bin/pdftotext" "$@"
            EOF
            chmod +x out/pdftotext.sh

            # Pack
            tar -czf pdftotext-el7-bundle.tar.gz -C out .
          '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdftotext-el7-bundle
          path: pdftotext-el7-bundle.tar.gz
