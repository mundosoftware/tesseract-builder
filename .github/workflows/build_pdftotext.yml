name: Build pdftotext bundle for EL7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Build inside CentOS 7 container (fixed vault repos)
        run: |
          docker run --rm -v "$PWD:/work" -w /work centos:7 bash -lc '
            set -euo pipefail

            # Fix DNS just in case (rarely needed, but safe)
            echo "nameserver 1.1.1.1" > /etc/resolv.conf

            # CentOS 7 is EOL. Use vault.centos.org for 7.9.2009.
            cat > /etc/yum.repos.d/CentOS-Base.repo << "EOF"
            [base]
            name=CentOS-7 - Base
            baseurl=http://vault.centos.org/7.9.2009/os/$basearch/
            gpgcheck=0
            enabled=1

            [updates]
            name=CentOS-7 - Updates
            baseurl=http://vault.centos.org/7.9.2009/updates/$basearch/
            gpgcheck=0
            enabled=1

            [extras]
            name=CentOS-7 - Extras
            baseurl=http://vault.centos.org/7.9.2009/extras/$basearch/
            gpgcheck=0
            enabled=1
            EOF

            yum clean all
            yum makecache fast

            yum -y install poppler-utils

            mkdir -p out/bin out/lib

            cp -v /usr/bin/pdftotext out/bin/

            # Copy shared libs required by pdftotext
            ldd /usr/bin/pdftotext | awk "/=>/ {print \$3}" | while read -r lib; do
              if [ -f "$lib" ]; then
                cp -v "$lib" out/lib/
              fi
            done

            # Copy runtime loader
            if [ -f /lib64/ld-linux-x86-64.so.2 ]; then
              cp -v /lib64/ld-linux-x86-64.so.2 out/lib/
            fi

            # Wrapper
            cat > out/pdftotext.sh << "EOF"
            #!/bin/sh
            DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"
            export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"
            exec "$DIR/bin/pdftotext" "$@"
            EOF
            chmod +x out/pdftotext.sh

            tar -czf pdftotext-el7-bundle.tar.gz -C out .
          '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdftotext-el7-bundle
          path: pdftotext-el7-bundle.tar.gz
