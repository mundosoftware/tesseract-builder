name: Build pdftotext bundle for EL7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build bundle in CentOS 7 container (no heredocs)
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -la

          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w /work \
            centos:7 bash -lc '
              set -euo pipefail

              echo "nameserver 1.1.1.1" > /etc/resolv.conf

              # Write CentOS 7 vault repos safely (no heredoc)
              printf "%s\n" \
"[base]" \
"name=CentOS-7 - Base" \
"baseurl=http://vault.centos.org/7.9.2009/os/\$basearch/" \
"gpgcheck=0" \
"enabled=1" \
"" \
"[updates]" \
"name=CentOS-7 - Updates" \
"baseurl=http://vault.centos.org/7.9.2009/updates/\$basearch/" \
"gpgcheck=0" \
"enabled=1" \
"" \
"[extras]" \
"name=CentOS-7 - Extras" \
"baseurl=http://vault.centos.org/7.9.2009/extras/\$basearch/" \
"gpgcheck=0" \
"enabled=1" \
> /etc/yum.repos.d/CentOS-Base.repo

              yum clean all
              yum makecache fast
              yum -y install poppler-utils

              rm -rf /work/out
              mkdir -p /work/out/bin /work/out/lib

              cp -v /usr/bin/pdftotext /work/out/bin/

              # Bundle libs
              ldd /usr/bin/pdftotext | awk "/=>/ {print \$3}" | while read -r lib; do
                if [ -f "$lib" ]; then
                  cp -v "$lib" /work/out/lib/
                fi
              done

              # Loader (sometimes helps)
              if [ -f /lib64/ld-linux-x86-64.so.2 ]; then
                cp -v /lib64/ld-linux-x86-64.so.2 /work/out/lib/
              fi

              # Wrapper (no heredoc)
              printf "%s\n" \
"#!/bin/sh" \
"DIR=\"\$(CDPATH= cd -- \"\$(dirname -- \"\$0\")\" && pwd)\"" \
"export LD_LIBRARY_PATH=\"\$DIR/lib:\$LD_LIBRARY_PATH\"" \
"exec \"\$DIR/bin/pdftotext\" \"\$@\"" \
> /work/out/pdftotext.sh

              chmod +x /work/out/pdftotext.sh

              # Create tarball in the mounted workspace
              tar -czf /work/pdftotext-el7-bundle.tar.gz -C /work/out .

              echo "=== inside container /work ==="
              ls -la /work
            '

          echo "=== on runner after docker ==="
          ls -la
          test -f pdftotext-el7-bundle.tar.gz
          ls -la pdftotext-el7-bundle.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdftotext-el7-bundle
          path: pdftotext-el7-bundle.tar.gz
          if-no-files-found: error
