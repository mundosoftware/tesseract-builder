name: Build tesseract (static-ish) for Linux x86_64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build tesseract in Docker (musl)
        run: |
          cat > Dockerfile <<'EOF'
          FROM alpine:3.20

          RUN apk add --no-cache \
            build-base cmake ninja pkgconfig git \
            autoconf automake libtool \
            leptonica-dev \
            icu-dev pango-dev cairo-dev \
            libjpeg-turbo-dev libpng-dev tiff-dev zlib-dev \
            wget tar

          WORKDIR /src

          # Build tesseract from source
          RUN git clone --depth 1 https://github.com/tesseract-ocr/tesseract.git
          WORKDIR /src/tesseract
          RUN mkdir build && cd build && \
              cmake -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_SHARED_LIBS=OFF \
                -DCMAKE_C_FLAGS="-O2 -pipe -march=x86-64 -mtune=generic" \
                -DCMAKE_CXX_FLAGS="-O2 -pipe -march=x86-64 -mtune=generic" \
                .. && \
              ninja

          # Stage output
          RUN mkdir -p /out/bin/tessdata && \
              cp build/bin/tesseract /out/bin/tesseract && \
              chmod +x /out/bin/tesseract

          # Download tessdata (eng+por)
          RUN wget -O /out/bin/tessdata/eng.traineddata https://github.com/tesseract-ocr/tessdata/raw/main/eng.traineddata && \
              wget -O /out/bin/tessdata/por.traineddata https://github.com/tesseract-ocr/tessdata/raw/main/por.traineddata

          EOF

          docker build -t tesseract-build .
          CID=$(docker create tesseract-build)
          docker cp "$CID:/out" ./out
          docker rm "$CID"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract_out
          path: out
